<div id="canvasDiv">
  <p>Draw number and click send to get prediction.</p>
  <br/>
  <canvas id="canvas" width=200 height=200></canvas>
  <br/>
  <button id="clear">Clear Canvas</button>
  <button id="send">Send</button>
  <br/>
  <%for i in 0..9 %>
    <canvas id="canvas<%=i%>" width=80 height=80></canvas>
  <% end %>
  <br/>
</div>

<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script type="text/javascript">

    var canvas;
    var context;
    var clickX = new Array();
    var clickY = new Array();
    var clickDrag = new Array();
    var paint;

    $(function () {
        canvas = document.getElementById("canvas");
        context = canvas.getContext("2d");

        for(var i = 0; i < 10; ++i)
            drawNumber(i, 1.0);

        $('#canvas').mousedown(function(e){
            var mouseX = e.pageX - this.offsetLeft;
            var mouseY = e.pageY - this.offsetTop;

            paint = true;
            addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
            redraw();
        });

        $('#canvas').mousemove(function(e){
            if(paint){
                addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
                redraw();
            }
        });

        $('#canvas').mouseup(function(e){
            paint = false;
        });

        $('#canvas').mouseleave(function(e){
            paint = false;
        });

        $('#clear').mousedown(function(e)
        {
            clickX = new Array();
            clickY = new Array();
            clickDrag = new Array();
            clearCanvas();
        });

        $('#send').mousedown(function(e)
        {
            div = document.getElementById("canvasDiv");
            scaleCanvas = document.createElement('canvas');
            scaleCanvas.setAttribute('width', 28);
            scaleCanvas.setAttribute('height', 28);
            scaleCanvas.setAttribute('id', 'scaleCanvas');
            div.appendChild(scaleCanvas);
            var scaleContex = scaleCanvas.getContext('2d');
            scaleContex.scale(0.14, 0.14);
            scaleContex.drawImage(canvas, 0, 0);

            var imageData = scaleContex.getImageData(0, 0, scaleCanvas.getAttribute('width'), scaleCanvas.getAttribute('height'));
            var data = imageData.data;

            var pixels = new Array();
            for(var i = 0; i < data.length/4; ++i) {
                var brightness = 0.34 * data[4*i] + 0.5 * data[4*i + 1] + 0.16 * data[4*i + 2];
                // red
                data[4*i] = 255 - brightness;
                // green
                data[4*i + 1] = 255 - brightness;
                // blue
                data[4*i + 2] = 255 - brightness;
                //alpha
                data[4*i + 3] = 255;

                pixels[i] = 255 - brightness;
            }

            scaleContex.putImageData(imageData, 0, 0);

            var jsonPixels = JSON.stringify(pixels, null, 2);
            $.ajax({
                type:  'post',
                url:  'test',
                data:  {pixels: pixels},
                dataType: 'json',
                success: function(resp) {
                    for(var i = 0; i < 10; ++i)
                        if(resp[i] < 0.0)
                            drawNumber(i, 0.0);
                        else if(resp[i] >= 1.0)
                            drawNumber(i, 1.0);
                        else
                            drawNumber(i, resp[i]);
                }

            });
        });
    });


    function drawNumber(n, alpha)
    {
        canvasN = document.getElementById("canvas"+ n.toString());
        contextN = canvasN.getContext("2d");
        contextN.clearRect(0, 0, canvasN.width, canvasN.height);
        contextN.font='60pt Calibri';
        contextN.textAlign = 'center';
        contextN.textBaseline = 'middle';
        contextN.globalAlpha = alpha;
        var x = canvasN.width / 2;
        var y = canvasN.height / 2;
        contextN.fillText(n.toString(),x,y);
    }

    function addClick(x, y, dragging)
    {
        clickX.push(x);
        clickY.push(y);
        clickDrag.push(dragging);
    }

    function clearCanvas()
    {
        context.fillStyle="#ffffff";
        context.fillRect(0, 0, canvas.getAttribute('width'), canvas.getAttribute('height'));
    }

    function redraw(){
        clearCanvas(); // Clears the canvas

        context.strokeStyle = "#000000";
        context.lineJoin = "round";
        context.lineWidth = 8;

        for(var i=0; i < clickX.length; i++) {
            context.beginPath();
            if(clickDrag[i] && i){
                context.moveTo(clickX[i-1], clickY[i-1]);
            }else{
                context.moveTo(clickX[i]-1, clickY[i]);
            }
            context.lineTo(clickX[i], clickY[i]);
            context.closePath();
            context.stroke();
        }
    }
</script>